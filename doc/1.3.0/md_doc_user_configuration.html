<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libxkbcommon: User-configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libxkbcommon
   &#160;<span id="projectnumber">1.3.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">User-configuration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page describes how to add a custom layout or option so that it will be parsed by libxkbcommon.</p>
<p><b>The below requires libxkbcommon as keymap compiler and does not work in X</b>.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Data locations</h1>
<p>libxkbcommon searches the following paths for XKB configuration files:</p><ul>
<li><code>$XDG_CONFIG_HOME/xkb/</code>, or <code>$HOME/.config/xkb/</code> if the <code>$XDG_CONFIG_HOME</code> environment variable is not defined</li>
<li><code>$HOME/.xkb/</code></li>
<li><code>$XKB_CONFIG_EXTRA_PATH</code> if set, otherswise <code>&lt;sysconfdir&gt;/xkb</code> (on most distributions this is <code>/etc/xkb</code>)</li>
<li><code>$XKB_CONFIG_ROOT</code> if set, otherwise <code>&lt;datadir&gt;/X11/xkb/</code> (path defined by the <code>xkeyboard-config</code> package, on most distributions this is <code>/usr/share/X11/xkb</code>)</li>
</ul>
<p>A keymap created with <code><a class="el" href="group__keymap.html#ga502717aa7148fd17d4970896f1e9e06f" title="Create a keymap from RMLVO names.">xkb_keymap_new_from_names()</a></code> will look up those paths in order until the required data is found.</p>
<p><b>Note: Where libxkbcommon runs in a privileged context, only the system (datadir) path is available.</b></p>
<p>Each directory should have one or more of the following subdirectories:</p><ul>
<li><code>compat</code></li>
<li><code>geometry</code> (libxkbcommon ignores this directory)</li>
<li><code>keycodes</code></li>
<li><code>rules</code></li>
<li><code>symbols</code></li>
<li><code>types</code></li>
</ul>
<p>The majority of user-specific configuration involve modifying key symbols and this is what this document focuses on. For use-cases where a user may need to add new key types or compat entries the general approach remains the same. A detailed description for how to add those types or compat entries is out of scope for this document.</p>
<p>You should never need to add user-specific keycodes. Where a keycode is missing, the addition should be filed in the upstream xkeyboard-config project.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
RMLVO vs KcCGST</h1>
<p>Due to how XKB is configured, there is no such thing as a "layout" in XKB itself, or, indeed, any of the rules, models, variant, options (RMLVO) decribed in <code>struct <a class="el" href="structxkb__rule__names.html" title="Names to compile a keymap with, also known as RMLVO.">xkb_rule_names</a></code>. RMLVO names are merely lookup keys in the rules file provided by xkeyboard-config to map to the correct keycode, compat, geometry (ignored by libxkbcommon), symbols and types (KcCGST). The KcCGST data is the one used by XKB and libxbkcommon to map keys to actual symbols.</p>
<p>For example, a common RMLVO configuration is layout "us", variant "dvorak" and option "terminate:ctrl_alt_bksp". Using the default rules file and model this maps into the following KcCGST components:</p>
<div class="fragment"><div class="line">xkb_keymap {</div>
<div class="line">    xkb_keycodes  { include &quot;evdev+aliases(qwerty)&quot; };</div>
<div class="line">    xkb_types     { include &quot;complete&quot;  };</div>
<div class="line">    xkb_compat    { include &quot;complete&quot;  };</div>
<div class="line">    xkb_symbols   { include &quot;pc+us(dvorak)+inet(evdev)+terminate(ctrl_alt_bksp)&quot;    };</div>
<div class="line">    xkb_geometry  { include &quot;pc(pc105)&quot; };</div>
<div class="line">};</div>
</div><!-- fragment --><p>A detailed explanation of how rules files convert RMLVO to KcCGST is out of scope for this document. See <a href="md_doc_rules-format.html">the rules file</a> page instead.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Adding a layout</h1>
<p>Adding a layout requires that the user adds <b>symbols</b> in the correct location.</p>
<p>The default rules files (usually <code>evdev</code>) have a catch-all to map a layout, say "foo", and a variant, say "bar", into the "bar" section in the file <code>$xkb_base_dir/symbols/foo</code>. This is sufficient to define a new keyboard layout. The example below defines the keyboard layout "banana" with an optional variant "orange"</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/banana</div>
<div class="line">// Like a US layout but swap the top row so numbers are on Shift</div>
<div class="line">default partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;basic&quot; {</div>
<div class="line">    include &quot;us(basic)&quot;</div>
<div class="line">    name[Group1]= &quot;Banana (US)&quot;;</div>
<div class="line"> </div>
<div class="line">    key &lt;AE01&gt; { [ exclam,          1]     };</div>
<div class="line">    key &lt;AE02&gt; { [ at,              2]     };</div>
<div class="line">    key &lt;AE03&gt; { [ numbersign,      3]     };</div>
<div class="line">    key &lt;AE04&gt; { [ dollar,          4]     };</div>
<div class="line">    key &lt;AE05&gt; { [ percent,         5]     };</div>
<div class="line">    key &lt;AE06&gt; { [ asciicircum,     6]     };</div>
<div class="line">    key &lt;AE07&gt; { [ ampersand,       7]     };</div>
<div class="line">    key &lt;AE08&gt; { [ asterisk,        8]     };</div>
<div class="line">    key &lt;AE09&gt; { [ parenleft,       9]     };</div>
<div class="line">    key &lt;AE10&gt; { [ parenright,      0]     };</div>
<div class="line">    key &lt;AE11&gt; { [ underscore,      minus] };</div>
<div class="line">    key &lt;AE12&gt; { [ plus,            equal] };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">// Same as banana but map the euro sign to the 5 key</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;orange&quot; {</div>
<div class="line">    include &quot;banana(basic)&quot;</div>
<div class="line">    name[Group1] = &quot;Banana (Eurosign on 5)&quot;;</div>
<div class="line">    include &quot;eurosign(5)&quot;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The <code>default</code> section is loaded when no variant is given. The first example sections uses <code>include</code> to populate with a symbols list defined elsewhere (here: section <code>basic</code> from the file <code>symbols/us</code>, aka. the default US keyboard layout) and overrides parts of these symbols. The effect of this section is to swap the numbers and symbols in the top-most row (compared to the US layout) but otherwise use the US layout.</p>
<p>The "orange" variant uses the "banana" symbols and includes a different section to define the eurosign. It does not specificially override any symbols.</p>
<p>The exact details of how <code>xkb_symbols</code> work is out of scope for this document.</p>
<h1><a class="anchor" id="autotoc_md17"></a>
Adding an option</h1>
<p>For technical reasons, options do <b>not</b> have a catch-all to map option names to files and sections and must be specifically mapped by the user. This requires a custom rules file. As the <code>evdev</code> ruleset is hardcoded in many clients, the custom rules file must usually be named <code>evdev</code>.</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/rules/evdev</div>
<div class="line">! option = symbols</div>
<div class="line">  custom:foo    = +custom(bar)</div>
<div class="line">  custom:baz    = +other(baz)</div>
<div class="line"> </div>
<div class="line">! include %S/evdev</div>
</div><!-- fragment --><p>This rules file maps the RMLVO option "custom:foo" to the "bar" section in the <code>symbols/custom</code> file and the "custom:baz" option to the "baz" section in the <code>symbols/other</code> file. Note how the RMLVO option name may be different to the file or section name.</p>
<p>The <code>include</code> statement includes the system-provided <code>evdev</code> ruleset. This allows users to only override those options they need.</p>
<p>The files themselves are similar to the layout examples in the previous section:</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/custom</div>
<div class="line">// map the Tilde key to nothing on the first shift level</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;bar&quot; {</div>
<div class="line">    key &lt;TLDE&gt; {        [      VoidSymbol ]       };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/other</div>
<div class="line">// map first key in bottom row (Z in the US layout) to k/K</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;baz&quot; {</div>
<div class="line">    key &lt;AB01&gt; {        [      k, K ]       };</div>
<div class="line">};</div>
</div><!-- fragment --><p>With these in place, a user may select any layout/variant together with the "custom:foo" and/or "custom:baz" options.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Discoverable layouts</h1>
<p><b>The below requires libxkbregistry as XKB lookup tool and does not work where clients parse the XML file directly</b>.</p>
<p>The above sections apply only to the data files and require that the user knows about the existence of the new entries. To make custom entries discoverable by the configuration tools (e.g. the GNOME Control Center), the new entries must also be added to the XML file that is parsed by libxkbregistry. In most cases, this is the <code>evdev.xml</code> file in the rules directory. The example below shows the XML file that would add the custom layout and custom options as outlined above to the XKB registry:</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/rules/evdev.xml</div>
<div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div>
<div class="line">&lt;!DOCTYPE xkbConfigRegistry SYSTEM &quot;xkb.dtd&quot;&gt;</div>
<div class="line">&lt;xkbConfigRegistry version=&quot;1.1&quot;&gt;</div>
<div class="line">  &lt;layoutList&gt;</div>
<div class="line">    &lt;layout&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;banana&lt;/name&gt;</div>
<div class="line">        &lt;shortDescription&gt;ban&lt;/shortDescription&gt;</div>
<div class="line">        &lt;description&gt;Banana&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;variantList&gt;</div>
<div class="line">        &lt;variant&gt;</div>
<div class="line">          &lt;configItem&gt;</div>
<div class="line">            &lt;name&gt;orange&lt;/name&gt;</div>
<div class="line">            &lt;shortDescription&gt;or&lt;/shortDescription&gt;</div>
<div class="line">            &lt;description&gt;Orange (Banana)&lt;/description&gt;</div>
<div class="line">          &lt;/configItem&gt;</div>
<div class="line">        &lt;/variant&gt;</div>
<div class="line">      &lt;/variantList&gt;</div>
<div class="line">    &lt;/layout&gt;</div>
<div class="line">  &lt;/layoutList&gt;</div>
<div class="line">  &lt;optionList&gt;</div>
<div class="line">    &lt;group allowMultipleSelection=&quot;true&quot;&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Custom options&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;option&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom:foo&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Map Tilde to nothing&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;/option&gt;</div>
<div class="line">      &lt;option&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom:baz&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Map Z to K&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;/option&gt;</div>
<div class="line">    &lt;/group&gt;</div>
<div class="line">  &lt;/optionList&gt;</div>
<div class="line">&lt;/xkbConfigRegistry&gt;</div>
</div><!-- fragment --><p>The default behavior of libxkbregistry ensures that the new layout and options are added to the system-provided layouts and options.</p>
<p>For details on the XML format, see DTD in <code>&lt;datadir&gt;/X11/xkb/rules/xkb.dtd</code> and the system-provided XML files in <code>&lt;datadir&gt;/X11/xkb/rulies/xkb.dtd</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
