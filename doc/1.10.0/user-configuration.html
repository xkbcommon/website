<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libxkbcommon: User-configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libxkbcommon<span id="projectnumber">&#160;1.10.0</span>
   </div>
   <div id="projectbrief">Library implementing the XKB specification for parsing                           keyboard descriptions and handling keyboard state</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">User-configuration</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#user-config-locations">Data locations</a>
  </li>
  <li class="level1">
    <a href="#rmlvo-vs-kccgst">RMLVO vs KcCGST</a>
  </li>
  <li class="level1">
    <a href="#user-config-layout">Adding a layout</a>
  </li>
  <li class="level1">
    <a href="#adding-an-option">Adding an option</a>
  </li>
  <li class="level1">
    <a href="#user-config-system-file-names">Using system file names</a>
  </li>
  <li class="level1">
    <a href="#discoverable-layouts">Discoverable layouts</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doc_2user-configuration"></a></p>
<p>This page describes how to add a <em>custom</em> layout or option so that it will be parsed by libxkbcommon.</p>
<dl class="section note"><dt>Note</dt><dd>For an introduction to XKB and keymap components, please see “<a class="el" href="xkb-intro.html">Introduction to XKB</a>”.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>The below requires libxkbcommon as keymap compiler and <b>does not work in X</b>.</dd></dl>
<dl class="section important"><dt>Important</dt><dd>An erroneous XKB configuration may make your keyboard unusable. Therefore it is advised to try custom configurations safely using <code>xkbcli</code> tools; see <a class="el" href="debugging.html#testing-custom-config">debugging</a> for further details.</dd></dl>
<h1><a class="anchor" id="user-config-locations"></a>
Data locations</h1>
<p>libxkbcommon searches the following paths for XKB configuration files:</p><ol type="1">
<li><code>$XDG_CONFIG_HOME/xkb/</code>, or <code>$HOME/.config/xkb/</code> if the <code>$XDG_CONFIG_HOME</code> environment variable is not defined. See the <a href="https://specifications.freedesktop.org/basedir-spec/latest/">XDG Base Directory Specification</a> for further details.</li>
<li><div> <dl class="deprecated"><dt><b><a class="el" href="deprecated.html#_deprecated000001">Deprecated</a></b></dt><dd><code>$HOME/.xkb/</code> as a <em>legacy</em> alternative to the previous XDG option. </dd></dl>
</div></li>
<li><code>$XKB_CONFIG_EXTRA_PATH</code> if set, otherwise <code>&lt;sysconfdir&gt;/xkb</code> (on most distributions this is <code>/etc/xkb</code>).</li>
<li><code>$XKB_CONFIG_ROOT</code> if set, otherwise <code>&lt;datadir&gt;/X11/xkb/</code> (path defined by the <code>xkeyboard-config</code> package, on most distributions this is <code>/usr/share/X11/xkb</code>).</li>
</ol>
<p>A keymap created with <code><a class="el" href="group__keymap.html#ga3a2d973b77325337f043a37edf4cc4e1" title="Create a keymap from RMLVO names.">xkb_keymap::xkb_keymap_new_from_names()</a></code> will look up those paths in order until the required data is found.</p>
<dl class="section note"><dt>Note</dt><dd>Where libxkbcommon runs in a privileged context, only the system (<code>&lt;datadir&gt;</code>) path is available.</dd></dl>
<p>Each directory should have one or more of the following subdirectories:</p><ul>
<li><code>compat</code></li>
<li><code>geometry</code> (libxkbcommon ignores this directory)</li>
<li><code>keycodes</code></li>
<li><code>rules</code></li>
<li><code>symbols</code></li>
<li><code>types</code></li>
</ul>
<p>The majority of user-specific configurations involve modifying key symbols and this is what this document focuses on. For use-cases where a user may need to add new key types or compat entries the general approach remains the same. A detailed description for how to add those types or compat entries is out of scope for this document.</p>
<p>You should never need to add user-specific keycodes. Where a keycode is missing, the addition should be filed in the upstream <a href="https://gitlab.freedesktop.org/xkeyboard-config/xkeyboard-config">xkeyboard-config</a> project.</p>
<h1><a class="anchor" id="rmlvo-vs-kccgst"></a>
RMLVO vs KcCGST</h1>
<p>Due to how XKB is configured, there is no such thing as a "layout" in XKB itself, or, indeed, any of the rules, models, variant, options (<a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a>) described in <code>struct <a class="el" href="structxkb__rule__names.html" title="Names to compile a keymap with, also known as RMLVO.">xkb_rule_names</a></code>. <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> names are merely lookup keys in the rules file provided by <a href="https://gitlab.freedesktop.org/xkeyboard-config/xkeyboard-config">xkeyboard-config</a> to map to the correct keycode, compat, geometry (ignored by libxkbcommon), symbols and types (<a class="el" href="xkb-intro.html#KcCGST-intro">KcCGST</a>). The <a class="el" href="xkb-intro.html#KcCGST-intro">KcCGST</a> data is the one used by XKB and libxkbcommon to map keys to actual symbols.</p>
<p>For example, a common <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> configuration is layout "us", variant "dvorak" and option "terminate:ctrl_alt_bksp". Using the default rules file and model this maps into the following <a class="el" href="xkb-intro.html#KcCGST-intro">KcCGST</a> components:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structxkb__keymap.html">xkb_keymap</a> {</div>
<div class="line">    xkb_keycodes  { include <span class="stringliteral">&quot;evdev+aliases(qwerty)&quot;</span> };</div>
<div class="line">    xkb_types     { include <span class="stringliteral">&quot;complete&quot;</span>  };</div>
<div class="line">    xkb_compat    { include <span class="stringliteral">&quot;complete&quot;</span>  };</div>
<div class="line">    xkb_symbols   { include <span class="stringliteral">&quot;pc+us(dvorak)+inet(evdev)+terminate(ctrl_alt_bksp)&quot;</span>    };</div>
<div class="line">    xkb_geometry  { include <span class="stringliteral">&quot;pc(pc105)&quot;</span> };</div>
<div class="line">};</div>
<div class="ttc" id="astructxkb__keymap_html"><div class="ttname"><a href="structxkb__keymap.html">xkb_keymap</a></div><div class="ttdoc">Opaque compiled keymap object.</div></div>
</div><!-- fragment --><p>A detailed explanation of how rules files convert <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> to <a class="el" href="xkb-intro.html#KcCGST-intro">KcCGST</a> is out of scope for this document. See <a href="md_doc_rules-format.html">the rules file</a> page instead.</p>
<h1><a class="anchor" id="user-config-layout"></a>
Adding a layout</h1>
<p>Adding a layout requires that the user adds <b>symbols</b> in the correct location.</p>
<p>The default rules files (usually <code>evdev</code>) have a catch-all to map a layout, say "foo", and a variant, say "bar", into the "bar" section in the file <code>$xkb_base_dir/symbols/foo</code>. This is sufficient to define a new keyboard layout. The example below defines the keyboard layout "banana" with an optional variant "orange":</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/banana</div>
<div class="line">// Like a US layout but swap the top row so numbers are on Shift</div>
<div class="line">default partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;basic&quot; {</div>
<div class="line">    include &quot;us(basic)&quot;</div>
<div class="line">    name[Group1]= &quot;Banana (US)&quot;;</div>
<div class="line"> </div>
<div class="line">    key &lt;AE01&gt; { [ exclam,          1]     };</div>
<div class="line">    key &lt;AE02&gt; { [ at,              2]     };</div>
<div class="line">    key &lt;AE03&gt; { [ numbersign,      3]     };</div>
<div class="line">    key &lt;AE04&gt; { [ dollar,          4]     };</div>
<div class="line">    key &lt;AE05&gt; { [ percent,         5]     };</div>
<div class="line">    key &lt;AE06&gt; { [ asciicircum,     6]     };</div>
<div class="line">    key &lt;AE07&gt; { [ ampersand,       7]     };</div>
<div class="line">    key &lt;AE08&gt; { [ asterisk,        8]     };</div>
<div class="line">    key &lt;AE09&gt; { [ parenleft,       9]     };</div>
<div class="line">    key &lt;AE10&gt; { [ parenright,      0]     };</div>
<div class="line">    key &lt;AE11&gt; { [ underscore,      minus] };</div>
<div class="line">    key &lt;AE12&gt; { [ plus,            equal] };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">// Same as banana but map the euro sign to the 5 key</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;orange&quot; {</div>
<div class="line">    include &quot;banana(basic)&quot;</div>
<div class="line">    name[Group1] = &quot;Banana (Eurosign on 5)&quot;;</div>
<div class="line">    include &quot;eurosign(5)&quot;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The <code>default</code> section is loaded when no variant is given. The first example sections uses <code>include</code> to populate with a symbols list defined elsewhere (here: section <code>basic</code> from the file <code>symbols/us</code>, aka. the default US keyboard layout) and overrides parts of these symbols. The effect of this section is to swap the numbers and symbols in the top-most row (compared to the US layout) but otherwise use the US layout.</p>
<p>The "orange" variant uses the "banana" symbols and includes a different section to define the <code>eurosign</code>. It does not specifically override any symbols.</p>
<p>The exact details of how <code>xkb_symbols</code> section works is out of scope for this document; see: <a class="el" href="keymap-text-format-v1.html">The XKB keymap text format, V1</a>.</p>
<dl class="section remark"><dt>Remarks</dt><dd>This example uses a file name "banana" that should not clash with the system files in <code>&lt;datadir&gt;/X11/xkb/symbols</code>. Using the same file name than the system files is possible but may require special handling, see: <a class="el" href="#user-config-system-file-names">Using system file names</a>.</dd></dl>
<h1><a class="anchor" id="adding-an-option"></a>
Adding an option</h1>
<p>For technical reasons, options do <b>not</b> have a catch-all to map option names to files and sections and must be specifically mapped by the user. This requires a custom rules file. As the <code>evdev</code> ruleset is hardcoded in many clients, the custom rules file must usually be named <code>evdev</code>.</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/rules/evdev</div>
<div class="line">// Mandatory to extend the</div>
<div class="line">! include %S/evdev</div>
<div class="line"> </div>
<div class="line">! option = symbols</div>
<div class="line">  custom:foo    = +custom(bar)</div>
<div class="line">  custom:baz    = +other(baz)</div>
</div><!-- fragment --><p>The <code>include</code> statement includes the system-provided <code>evdev</code> ruleset. This allows users to only override those options they need afterwards.</p>
<p>This rules file maps the <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> option "custom:foo" to the "bar" section in the <code>symbols/custom</code> file and the "custom:baz" option to the "baz" section in the <code>symbols/other</code> file. Note how the <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> option name may be different to the file or section name.</p>
<dl class="section important"><dt>Important</dt><dd>The <em>order</em> of the options matter! In this example, <code>custom:foo</code> will <em>always</em> be applied <em>before</em> <code>custom:baz</code> and both options will <em>always</em> be applied <em>after</em> the system ones, even if the order is different in the <a class="el" href="xkb-intro.html#RMLVO-intro">RMLVO</a> configuration passed to libxkbcommon (e.g. with <code>xkbcli</code>). See the <a class="el" href="rule-file-format.html#irrelevant-options-order">related section</a> in the rules documentation for further details.</dd></dl>
<p>The files themselves are similar to the layout examples in the previous section:</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/custom</div>
<div class="line">// map the Tilde key to nothing on the first shift level</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;bar&quot; {</div>
<div class="line">    key &lt;TLDE&gt; {        [      VoidSymbol ]       };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/other</div>
<div class="line">// map first key in bottom row (Z in the US layout) to k/K</div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;baz&quot; {</div>
<div class="line">    key &lt;AB01&gt; {        [      k, K ]       };</div>
<div class="line">};</div>
</div><!-- fragment --><p>With these in place, a user may select any layout/variant together with the "custom:foo" and/or "custom:baz" options.</p>
<dl class="section remark"><dt>Remarks</dt><dd>This example uses file names "custom" and "other" that should not clash with the system files in <code>&lt;datadir&gt;/X11/xkb/symbols</code>. Using the same file name than the system files is possible but may require special handling, see: <a class="el" href="#user-config-system-file-names">Using system file names</a>.</dd></dl>
<h1><a class="anchor" id="user-config-system-file-names"></a>
Using system file names</h1>
<p>The previous examples use custom keymap files with file name that do not clash with the files in the <em>system</em> directory, <code>&lt;datadir&gt;/X11/xkb/</code>. It is possible to add a custom variant using the <em>same</em> file name than the system file, e.g. <code>$XDG_CONFIG_HOME/xkb/symbols/us</code> instead of <code>$XDG_CONFIG_HOME/xkb/symbols/banana</code> for the example in <a class="el" href="#user-config-layout">Adding a layout</a>.</p>
<p>However, it must then contains an <em>explicit default</em> section if the system file has one, else it may break the keyboard setup by including a section of the custom file instead of the system one. The default section should enforce that the system default section is included. If one wanted to define only the "orange" layout variant above, then the file would have been:</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/symbols/us</div>
<div class="line">default partial alphanumeric_keys xkb_symbols { include &quot;us(basic)&quot; };</div>
<div class="line"> </div>
<div class="line">partial alphanumeric_keys</div>
<div class="line">xkb_symbols &quot;orange&quot; {</div>
<div class="line">    include &quot;us(basic)&quot;</div>
<div class="line">    name[Group1] = &quot;Banana (Eurosign on 5)&quot;;</div>
<div class="line">    include &quot;eurosign(5)&quot;</div>
<div class="line">};</div>
</div><!-- fragment --><dl class="section since"><dt>Since</dt><dd>1.9.0 The requirement for an explicit default section is not necessary anymore: libxkbcommon will look up for the proper default section in the XKB paths.</dd></dl>
<h1><a class="anchor" id="discoverable-layouts"></a>
Discoverable layouts</h1>
<dl class="section warning"><dt>Warning</dt><dd>The below requires <code>libxkbregistry</code> as XKB lookup tool and <b>does not work where clients parse the XML file directly</b>.</dd></dl>
<p>The above sections apply only to the data files and require that the user knows about the existence of the new entries. To make custom entries discoverable by the configuration tools (e.g. the GNOME Control Center), the new entries must also be added to the XML file that is parsed by <code>libxkbregistry</code>. In most cases, this is the <code>evdev.xml</code> file in the rules directory. The example below shows the XML file that would add the custom layout and custom options as outlined above to the XKB registry:</p>
<div class="fragment"><div class="line">$ cat $XDG_CONFIG_HOME/xkb/rules/evdev.xml</div>
<div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div>
<div class="line">&lt;!DOCTYPE xkbConfigRegistry SYSTEM &quot;xkb.dtd&quot;&gt;</div>
<div class="line">&lt;xkbConfigRegistry version=&quot;1.1&quot;&gt;</div>
<div class="line">  &lt;layoutList&gt;</div>
<div class="line">    &lt;layout&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;banana&lt;/name&gt;</div>
<div class="line">        &lt;shortDescription&gt;ban&lt;/shortDescription&gt;</div>
<div class="line">        &lt;description&gt;Banana&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;variantList&gt;</div>
<div class="line">        &lt;variant&gt;</div>
<div class="line">          &lt;configItem&gt;</div>
<div class="line">            &lt;name&gt;orange&lt;/name&gt;</div>
<div class="line">            &lt;shortDescription&gt;or&lt;/shortDescription&gt;</div>
<div class="line">            &lt;description&gt;Orange (Banana)&lt;/description&gt;</div>
<div class="line">          &lt;/configItem&gt;</div>
<div class="line">        &lt;/variant&gt;</div>
<div class="line">      &lt;/variantList&gt;</div>
<div class="line">    &lt;/layout&gt;</div>
<div class="line">  &lt;/layoutList&gt;</div>
<div class="line">  &lt;optionList&gt;</div>
<div class="line">    &lt;group allowMultipleSelection=&quot;true&quot;&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Custom options&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;option&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom:foo&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Map Tilde to nothing&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;/option&gt;</div>
<div class="line">      &lt;option&gt;</div>
<div class="line">      &lt;configItem&gt;</div>
<div class="line">        &lt;name&gt;custom:baz&lt;/name&gt;</div>
<div class="line">        &lt;description&gt;Map Z to K&lt;/description&gt;</div>
<div class="line">      &lt;/configItem&gt;</div>
<div class="line">      &lt;/option&gt;</div>
<div class="line">    &lt;/group&gt;</div>
<div class="line">  &lt;/optionList&gt;</div>
<div class="line">&lt;/xkbConfigRegistry&gt;</div>
</div><!-- fragment --><p>The default behavior of <code>libxkbregistry</code> ensures that the new layout and options are added to the system-provided layouts and options.</p>
<p>For details on the XML format, see the DTD in <code>&lt;datadir&gt;/X11/xkb/rules/xkb.dtd</code> and the system-provided XML files <code>&lt;datadir&gt;/X11/xkb/rules/*.xml</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Depending on the desktop environment, it may require restarting the session in order to make the configuration changes effective.</dd>
<dd>
It is advised to try the custom configuration <em>before</em> restarting the session using the various <code>xkbcli</code> tools. See <a class="el" href="debugging.html#testing-custom-config">debugging</a> for further details. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
