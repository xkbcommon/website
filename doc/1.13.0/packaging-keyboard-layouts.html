<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libxkbcommon: Packaging keyboard layouts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libxkbcommon<span id="projectnumber">&#160;1.13.0</span>
   </div>
   <div id="projectbrief">Library implementing the XKB specification for parsing                           keyboard descriptions and handling keyboard state</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Packaging keyboard layouts </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#the-extensions-directories">The extensions directories </a>
  </li>
  <li class="level1">
    <a href="#lookup-mechanism">Lookup mechanism </a>
  </li>
  <li class="level1">
    <a href="#instructions-for-keyboard-layout-packagers">Instructions for keyboard layout packagers </a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doc_2packaging-keyboard-layouts"></a></p>
<p>Since version <b>1.13</b> xkbcommon facilitates installing keyboard layout packages using a new mechanism: the XKB <b>extensions directories</b>. It provides a proper way for keyboard layout packages to install their files, which otherwise resorted to hacking the xkeyboard-config system directory.</p>
<dl class="section note"><dt>Note</dt><dd>For <em>single-user</em> setups, see also <a class="el" href="user-configuration.html">User-configuration</a>.</dd></dl>
<h1 class="doxsection"><a class="anchor" id="the-extensions-directories"></a>
The extensions directories</h1>
<p>There are 2 root <b>extensions directories</b>, both optional:</p>
<dl>
<dt><em>Unversioned</em> directory: <code>XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH</code>  </dt>
<dd><p class="startdd">It is intended as the <em>default</em> extensions path and for <em>forward</em> compatibility.</p>
<p class="enddd">It defaults to: <span class="tt">&lt;xkeyboard-config-root&gt;</span> - version suffix + <span class="tt">.d</span>, e.g. <span class="tt">/usr/share/xkeyboard-config.d</span>.  </p>
</dd>
<dt><em>Versioned</em> directory: <code>XKB_CONFIG_VERSIONED_EXTENSIONS_PATH</code>  </dt>
<dd><p class="startdd">It is intended for <em>backward compatibility</em> with older xkeyboard-config packages.</p>
<p class="enddd">It defaults to: <span class="tt">&lt;xkeyboard-config-root&gt;</span> + <span class="tt">.d</span>, e.g. <span class="tt">/usr/share/xkeyboard-config-2.d</span>.  </p>
</dd>
</dl>
<dl class="section note"><dt>Note</dt><dd><span class="tt">XKB_CONFIG_VERSIONED_EXTENSIONS_PATH</span> has higher priority than <span class="tt">XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH</span>.</dd></dl>
<h1 class="doxsection"><a class="anchor" id="lookup-mechanism"></a>
Lookup mechanism</h1>
<p>When appending the default include paths, after the <em>extra</em> path but before the <em>canonical XKB root</em>, for each extensions directory hereinabove: its subdirectories are appended in <em>lexicographic order</em> to the include paths; <em>unversioned</em> subdirectories are appended only if there is no corresponding <em>versioned</em> subdirectory.</p>
<p>Example: given the following setup:</p><ul>
<li><span class="tt">XKEYBOARD_CONFIG_ROOT</span> = <span class="tt">/usr/share/xkeyboard-config-2</span></li>
<li><span class="tt">/usr/share/xkeyboard-config-2.d</span> tree:<ul>
<li><span class="tt">p1</span> (installed by package <em>p1</em>)<ul>
<li><span class="tt">rules/evdev.xml</span></li>
<li><span class="tt">symbols/a</span></li>
</ul>
</li>
<li><span class="tt">p2</span> (installed by package <em>p2</em>)<ul>
<li><span class="tt">rules/evdev.xml</span></li>
<li><span class="tt">symbols/b</span></li>
</ul>
</li>
</ul>
</li>
<li><span class="tt">/usr/share/xkeyboard-config.d</span> tree:<ul>
<li><span class="tt">p1</span> (installed by package <em>p1</em>)<ul>
<li><span class="tt">rules/evdev.xml</span></li>
<li><span class="tt">symbols/a</span></li>
</ul>
</li>
<li><span class="tt">p3</span> (installed by package <em>p3</em>)<ul>
<li><span class="tt">rules/evdev.xml</span></li>
<li><span class="tt">symbols/c</span></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>then the include path list may be:</p><ol type="1">
<li><span class="tt">~/.config/xkb</span> (<em>user</em> path)</li>
<li><span class="tt">~/.xkb</span> (alternative <em>user</em> path)</li>
<li><span class="tt">/etc/xkb</span> (<em>extra</em> path)</li>
<li><span class="tt">/usr/share/xkeyboard-config-2.d/p1</span></li>
<li><span class="tt">/usr/share/xkeyboard-config-2.d/p2</span></li>
<li><span class="tt">/usr/share/xkeyboard-config.d/p3</span></li>
<li><span class="tt">/usr/share/xkeyboard-config-2</span> (<em>canonical root</em>)</li>
</ol>
<p>In this example:</p><ul>
<li>Package <em>p1</em> distributes a layout with specific compatibility files for xkeyboard-config v2 and fallback files for v3+. In this case the versioned files have priority, so the unversioned <span class="tt">/usr/share/xkeyboard-config.d/p1</span> path is not included.</li>
<li>Package <em>p2</em> distributes only a layout specific to xkeyboard-config v2.</li>
<li>Package <em>p3</em> distributes a layout for any xkeyboard-config version.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="instructions-for-keyboard-layout-packagers"></a>
Instructions for keyboard layout packagers</h1>
<ol type="1">
<li>Add a dependency to <span class="tt">libxkbcommon</span> 1.13+ and <span class="tt">xkeyboard-config</span> 2.45+ using their pkg-config files. The <span class="tt">libxkbcommon</span> dependency will be necessary until xkeyboard-config ships a pkg-config file with the needed variables (see hereinafter).</li>
<li>Remove any installation step that modifies the <span class="tt">xkeyboard-config</span> directories, unless there is a need to provide the layout for <em>X11-only</em> sessions, because they do not support XKB directories other than the hard-coded one in the X server.</li>
<li><p class="startli">Install the XKB files in: <span class="tt">&lt;XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH&gt;/&lt;PACKAGE_NAME&gt;/&lt;KCCGST_DIR&gt;</span>, where: </p><dl>
<dt><code>XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH</code> </dt>
<dd>Set from the variable <span class="tt">xkb_unversioned_extensions_path</span> from the libxkbcommon or xkeyboard-config pkg-config file  </dd>
<dt><code>PACKAGE_NAME</code> </dt>
<dd>A <em>unique</em> identifier, typically the layout or package name. </dd>
<dt><code>KCCGST_DIR</code> </dt>
<dd>A XKB <a class="el" href="xkb-intro.html#KcCGST-intro">KcCGST</a> component directory, such as <span class="tt">symbols</span>, <span class="tt">types</span>, etc. </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>If a custom <em>rules</em> file is required (e.g. to add an <em>option</em>), name it <span class="tt">&lt;ruleset&gt;.post</span> (note the <span class="tt">.post</span> suffix) to enable composability with other packages. See <a class="el" href="rule-file-format.html#rmlvo-resolution">RMLVO resolution process</a> for further details.</dd></dl>
</li>
<li><p class="startli">Install the <em>registry file</em> at: <span class="tt">&lt;XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH&gt;/&lt;PACKAGE_NAME&gt;/rules/evdev.xml</span>.</p>
<p class="startli">See <a class="el" href="user-configuration.html#discoverable-layouts">Discoverable layouts</a> for further information.</p>
</li>
<li>When xkeyboard-config v3 is out:<ul>
<li><em>If</em> the keymap is updated to use features incompatible with xkeyboard-config v2, the v2 files are installed in <span class="tt">&lt;XKB_CONFIG_VERSIONED_EXTENSIONS_PATH_V2&gt;</span> (previously <span class="tt">&lt;XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH&gt;</span>) and then install the v3 files with the new features in <span class="tt">&lt;XKB_CONFIG_UNVERSIONED_EXTENSIONS_PATH&gt;</span>.</li>
<li><em>Otherwise</em> no change is required.</li>
</ul>
</li>
<li>When xkeyboard-config v4+ is out, proceed similarly to step 5 with the corresponding xkeyboard-config version. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
